---
title: "Put a real title here"
subtitle: "SDS 192: MP5"
author: 
- name: Sethatevy Bong
  affiliation: Smith College
- name: Esa Schenck
  affiliation: Smith College
-name: Veronica Kessler  
date: "`r format(Sys.Date(), '%B %e, %Y')`"
output: 
  html_document:
    toc: true
    toc_depth: 2
    toc_float: true
    fig_width: 7
    fig_height: 6
    fig_caption: true
    code_folding: show
    df_print: paged
editor_options: 
  chunk_output_type: inline
references:
- id: xie2016bookdown
  type: book
  title: "Bookdown: Authoring books and technical documents with R markdown"
  author: 
  - family: Xie
    given: Yihui
  issued:
    year: 2016
  publisher: CRC Press
  url: https://bookdown.org/yihui/rmarkdown/
---


```{r setup, include=FALSE}
library(tidyverse)
library(sds192)
library(RMySQL)
library(leaflet)
library(sf)
db <- dbConnect(
  MySQL(), 
  host = "scidb.smith.edu", 
  user = "sds192", 
  password = "DSismfc@S", 
  dbname = "airlines"
)
knitr::opts_chunk$set(
  message = FALSE,
  echo = TRUE, 
  connection = db, 
  max.print = 20
)
```


## Introduction

What is this article about? [^github]

[^github]: Please see [our GitHub repository](https://github.com/sds192-s20/mp3-group-*) for complete code. 

## Exploratory data analysis

```{sql, connection=db, output.var = "Trips_during_school_year"}
SELECT duration, birth_year, gender, start_station_id FROM citibike.trips
WHERE duration > 600
AND user_type = 'subscriber'
AND stop_time < '2017-06-01#' OR start_time > '2017-09-01#';
```


# We want to group those users younger than 30 and older than 30 to know which group uses the bike system more frequently

```{sql connection=db, output.var = "Trips"}
SELECT duration, birth_year, gender
 FROM citibike.trips
WHERE duration > 600
AND user_type = 'subscriber';

```

```{r}
thirty_or_younger <- Trips %>%
   filter(birth_year>=1987) %>%
 group_by(birth_year) %>% 
arrange(birth_year)
```

```{r}
older_than_thirty <- Trips %>% 
  filter(birth_year >= 1957, birth_year <= 1987) %>% 
  group_by(birth_year)
```

## Option 1 for graphs -- total trips people of each age group took

```{r}
Trips %>% 
  group_by(birth_year) %>% 
  filter(birth_year >= 1957) %>% 
  summarize(total = sum(n())) %>%
  ggplot(aes(x = birth_year, y = total)) + 
  geom_col()
```


### You could add gender

```{r}
Trips %>% 
  group_by(birth_year, gender) %>% 
  filter(birth_year >= 1957) %>% 
  summarize(total = sum(n())) %>%
  ggplot(aes(x = birth_year, y = total, fill = factor(gender))) + 
  geom_col()
```
Note: we still don't know which binary gender is 1 and which is 2.
ALSO NOTE: I'm pretty sure nonbinary is 0


## Option 2 for graphs -- average duration of trips people of each age group took

```{r}
Trips %>% 
  group_by(birth_year) %>% 
  filter(birth_year >= 1957) %>% 
  summarize(total = sum(n()),
            total_sec = sum(duration),
            total_min = total_sec/60,
            avg_min = total_min/total) %>%
  ggplot(aes(x = birth_year, y = avg_min)) + 
  geom_col()
```

<<<<<<< HEAD
=======

### You could add gender

```{r}
Trips %>% 
  group_by(birth_year, gender) %>% 
  filter(birth_year >= 1957) %>% 
  summarize(total = sum(n()),
            total_sec = sum(duration),
            total_min = total_sec/60,
            avg_min = total_min/total) %>%
  ggplot(aes(x = birth_year, y = avg_min , fill = factor(gender))) + 
  geom_col()
```
>>>>>>> 0c466bce0c4011e60e84f75e62af7f2092663d8f

Okay, I have no idea why those graphs look so different but I think that's the general idea


# Code Ben left as examples 
Make sure that you can get this chunk to run:

```{sql}
SHOW DATABASES;
```

If you want to save the results of your query as a data frame, that you can use in any later R chunks, add the `connection` and `output.var` chunk options, like this:

```{sql, connection=db, output.var="first_ten_airports"}
SELECT * FROM airports LIMIT 10;
```

Now we have this object in R:

```{r}
first_ten_airports
```

Please see the [SQL chapter of the `bookdown` book](
https://rmarkdown.rstudio.com/authoring_knitr_engines.html%23sql#sql) for more information. 

You can cite references using parentheses or not. @xie2016bookdown wrote about this. See also [@xie2016bookdown].

```{r airport-map, fig.cap="Map of the first ten airports."}
library(leaflet)
leaflet() %>%
  addTiles() %>%
  addMarkers(
    data = first_ten_airports,
    popup = ~name
  )
```


```{sql connection=db, output.var = "Trips"}
SELECT duration, birth_year, gender
 FROM citibike.trips
WHERE duration > 600
AND user_type = 'subscriber';

```


# Station Data

```{sql connection=db, output.var = "months_station"}
SELECT station_id, name, num_starts, num_stops, avg_lat, avg_lon
 FROM citibike.station_months 
```

What stations get the most average rides (both starts and stops)?

```{r}
months_station <- months_station %>% 
  select(-station_id) %>% 
  mutate(trips = num_starts + num_stops) %>% 
  group_by(name) %>% 
  summarize(total_months = sum(n()),
          total_trips = sum(trips),
          avg_trips = total_trips/total_months,
          avg_lat = first(avg_lat),
          avg_lon = first(avg_lon)
         )
```


```{r}
months_station %>% 
  ggplot(aes(x = name, y = avg_trips, fill = avg_trips)) +
  geom_col()
```
# Station Data

```{sql connection=db, output.var = "Popular_Stations"}
SELECT station_id, name, num_starts, num_stops, avg_lat, avg_lon
 FROM citibike.station_months 
 ORDER BY num_starts DESC;
```


```{r}
Top_50_Stations <- Popular_Stations %>%
  pivot_longer(-name, names_to = "Stations", values_to = "count")%>%head(50) 
```

```{r}

station_pal <- colorNumeric(
  palette = "RdBu", 
  domain = Top_50_Stations %>%
    pull(num_starts) %>%
    range())

leaflet(Top_50_Stations) %>% 
  addTiles() %>%
  addCircles(lng = ~avg_lon, lat = ~avg_lat, weight = 3,
    radius = ~sqrt(num_stops)*3,
    color = ~station_pal(num_stops), popup = paste("<b>",Top_50_Stations$name, "</b>", "<br>",
                           "Number of Stops:", Top_50_Stations$num_stops), opacity = 50)
```






## Analysis

What did you discover? 

## Conclusion

What did you *learn* about the data set your explored?  

---

## Word count

```{r word_count, message=FALSE, echo=FALSE}
sds192::text_stats()
```


## Standards

In this assignment, we are attempting the following standards:

```{r buttons, echo=FALSE}
standard_button("markdown")
standard_button("aesthetics")
standard_button("wrangling")
standard_button("context")
standard_button("reshape")
standard_button("relational")
standard_button("ethics")
standard_button("github")
standard_button("iteration")
standard_button("function")
standard_button("spatial")
standard_button("leaflet")
standard_button("query")
```

## References

